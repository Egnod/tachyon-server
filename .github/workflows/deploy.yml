name: Deploy to Deta

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
    - name: Install dependencies and deta-cli
      run: |
        ls
        python -m pip install --upgrade pip
        pip install setuptools wheel poetry attrs codecov
        poetry config virtualenvs.create false --local && poetry install --no-ansi -n
        curl -fsSL https://get.deta.dev/cli.sh | sh
    - name: Clone Deta Metadata
      shell: bash
      env:
        DETA_ACCESS_TOKEN: ${{ secrets.DETA_ENV }}
      run: |
        ~/.deta/bin/deta clone --name tachyon --project tachyon tmp/
        cp -r tmp/.deta .
    - name: Deploy to Deta
      shell: bash
      env:
        DETA_ACCESS_TOKEN: ${{ secrets.DETA_ENV }}
        DETA_ENV: ${{ secrets.DETA_ENV }}
      run: |
        echo "$DETA_ENV" > .env.deta
        ~/.deta/bin/deta update -n tachyon -e .env.deta
        ~/.deta/bin/deta deploy
